# 20.7. Homework 20

For Homework 20, you will turn our Chapter 20 demo (from the lab) into a more complete mini online
experiment. In addition to getting the survey to work and saving responses, you will implement
**TIPI scoring**, including **reverse scoring**, and store the computed trait scores in your
database. In addition, you will implement new endpoints for the experimenter, as well as a 
a script to populate the database with simulated data.

Your goals are:

- Serve the full 10-item TIPI survey as an HTML form
- Accept submissions with FastAPI
- Save raw responses to a SQLite database using SQLModel
- Compute the Big Five trait scores (including reverse scoring) on the server when the form is submitted
- Save the computed scores to the database
- Provide an experimenter-friendly way to view and export the data

## Project folder

Create a folder called `HW20/` (or reuse your Chapter 20 project folder and rename it). Inside it you
should have:

- `main.py`
- `models.py`
- `database.py`
- `templates/`
  - `survey.html`
  - `thank_you.html`
- `populate_db.py` (you will create this file yourself)

## Part 1: The complete TIPI survey (HTML)

Below we have the new `templates/survey.html` file, which will display the full 10-item TIPI scale
as an HTML form.

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>TIPI Survey</title>
  </head>
  <body>
    <h1>Personality Survey</h1>

    <p>
      Here are a number of personality traits that may or may not apply to you.
      Please indicate the extent to which you agree or disagree with each
      statement using a scale from 1 to 7, where 1 means "disagree strongly" and
      7 means "agree strongly". You should rate the extent to which the pair of
      traits applies to you, even if one characteristic applies more strongly
      than the other.
    </p>

    <form method="post" action="/submit">
      <ol>
        <li>
          <p><strong>I see myself as:</strong> Extraverted, enthusiastic.</p>
          <label for="tipi_1">Rating:</label>
          <select id="tipi_1" name="tipi_1" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Critical, quarrelsome.</p>
          <label for="tipi_2">Rating:</label>
          <select id="tipi_2" name="tipi_2" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Dependable, self-disciplined.</p>
          <label for="tipi_3">Rating:</label>
          <select id="tipi_3" name="tipi_3" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Anxious, easily upset.</p>
          <label for="tipi_4">Rating:</label>
          <select id="tipi_4" name="tipi_4" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p>
            <strong>I see myself as:</strong> Open to new experiences, complex.
          </p>
          <label for="tipi_5">Rating:</label>
          <select id="tipi_5" name="tipi_5" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Reserved, quiet.</p>
          <label for="tipi_6">Rating:</label>
          <select id="tipi_6" name="tipi_6" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Sympathetic, warm.</p>
          <label for="tipi_7">Rating:</label>
          <select id="tipi_7" name="tipi_7" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Disorganized, careless.</p>
          <label for="tipi_8">Rating:</label>
          <select id="tipi_8" name="tipi_8" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Calm, emotionally stable.</p>
          <label for="tipi_9">Rating:</label>
          <select id="tipi_9" name="tipi_9" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>

        <li>
          <p><strong>I see myself as:</strong> Conventional, uncreative.</p>
          <label for="tipi_10">Rating:</label>
          <select id="tipi_10" name="tipi_10" required>
            <option value="" selected>Please select an option</option>
            <option value="1">1 (disagree strongly)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4 (neither agree nor disagree)</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7 (agree strongly)</option>
          </select>
        </li>
      </ol>

      <div>
        <label for="comments">Any additional comments? (optional)</label><br />
        <textarea id="comments" name="comments" rows="4" cols="60"></textarea>
      </div>

      <button type="submit">Submit</button>
    </form>
  </body>
</html>
```

## Part 2: Updating data models

Update the `models.py` file so that the database stores:

- Raw TIPI responses: `tipi_1` through `tipi_10` (integers between 1 and 7)
- Optional `comments` string (up to 2000 characters long)
- Computed Big Five scores (floats):
  - `extraversion`
  - `agreeableness`
  - `conscientiousness`
  - `emotional_stability`
  - `openness`
    - To compute these scores, you will need to implement the scoring logic in your `/submit` route and add the computed scores to the entry in the database
- Server-generated fields: `id`, `created_at`

Validation remains important. All raw items input by the user must validate as integers between 1
and 7 using `Field(ge=1, le=7)`. The optional `comments` field should be a string with a maximum
length of 2000 characters.

## Part 3: Implement trait scoring of the Big Five

While half of the questions are straightforward to score, half of them are reverse-scored. E.g., if
the user entered a 7 for question 1, that should be scored as 1 (a 6 would become 2, a 5 would
become 3, etc.).

To compute the reverse of a score, you simply do `new_score = 8 - original_score`. We use 8 because
it's the maximum score (in this case, 7) plus 1.

Then, you can calculate the mean of the two items that are designed to measure the trait. For example, extraversion is the mean of item 1 and the reverse of
item 6. The full scoring key is given below:

- **Extraversion**: items 1 and 6 (reverse-scored)
- **Agreeableness**: items 2 (reverse-scored) and 7
- **Conscientiousness**: items 3 and 8 (reverse-scored)
- **Emotional Stability**: items 4 (reverse-scored) and 9
- **Openness**: items 5 and 10 (reverse-scored)

Implement a function (in the `main.py` file or a helper module) that:

- takes the responses `tipi_1` through `tipi_10` as integers
- performs reverse scoring where appropriate
- takes the mean of the two items for each trait
- returns the five trait scores as floating point numbers

Then, update your `/submit` route so it:

1. reads form inputs
2. converts the responses to integers
3. calls the function you just implemented to compute the trait scores
4. saves everything to the database

## Part 4: Experimenter features

As experimenters, we need some way to get access to the data we've collected, and to monitor the progress of the experiment as it's ongoing. To this end, add two new routes:

1. `GET /summary`

   - this route returns JSON summarizing the data collected so far
   - this summary includes:
     - the number of responses collected (`num_responses`)
     - the mean of the responses for each trait (`means`, which is a dictionary)
     - the standard deviation of the responses for each trait (`stds`, which is a dictionary)

   For example, the JSON for your experiment's summary could look something like this

   ```json
   {
     "num_responses": 42,
     "means": {
       "extraversion": 4.9,
       "agreeableness": 5.1,
       "conscientiousness": 4.2,
       "emotional_stability": 3.8,
       "openness": 5.6
     },
     "stds": {
       "extraversion": 1.1,
       "agreeableness": 0.9,
       "conscientiousness": 1.3,
       "emotional_stability": 1.4,
       "openness": 1.0
     }
   }
   ```

2. `GET /export_to_csv`
   - this route returns a CSV download of all responses
     - This can be accomplished by using either the `csv` module or the `pandas` library
     - For example, you can convert a given response to a dictionary using `response.model_dump()`
       and then write the dictionary to a CSV file using `csv` or `pandas`
     - Then you can return the CSV file as a `PlainTextResponse` (imported from `fastapi.responses`)
   - The CSV should include the raw item responses and computed scores for each entry

## Part 5: Test script to populate the database

Create `populate_db.py` that inserts **at least 30** automatically generated fake responses into the
database so you can easily test your two new endpoints from Part 4. (If your database has responses
in it that are malformed or that you don't want in there for any reason, you can delete the
`survey.db` file and run the script again.)

Your `populate_db.py` script must:

- generate random integers between 1 and 7 as responses for each survey question (`tipi_1` to
  `tipi_10`)
- include optional `comments` on some (but not all!) rows
  - You may "roll the dice" to decide whether to include a comment (let's say there is a 30% chance
    of a given entry having a comment)
  - A comment should be a random string of 10-30 characters (you can use the `random` module to
    generate a random string; see Chapter 3.5, 5.0, and 8.7 for examples)
  - Make sure to compute the trait scores for each response and save them to the database (using the
    function you implemented in Part 3)

## What to submit

Submit a zip file named `lastname_firstname_hw20.zip` It must include your entire `HW20/` folder
with all the code necessary to run the experiment. This includes your automatically populated
`survey.db` database file

When we unzip the project, it should run _as-is_ using the command `uvicorn main:app --reload`. If
it does not, then it will not be graded.

Next: TBD<br>
Previous: [20.6. Lab 20](20.6.%20Lab%2020.md)
