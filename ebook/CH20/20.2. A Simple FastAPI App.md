# 20.2. A Simple FastAPI App

In this section, we are going to write the smallest working FastAPI app possible, run it locally,
and use the built-in interactive documentation to test our endpoints. We will do so with the help of
the [FastAPI documentation](https://fastapi.tiangolo.com/), which gives us the basis for our working
code below.

## Step 1: Create a file called `main.py`

In your `bcog200_web` folder (the one where you ran `uv init`), create a file called `main.py` with
the following code:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, query: str | None = None):
    return {"item_id": item_id, "query": query}
```

### What is a "route" (aka an endpoint)?

A **route** (or **endpoint**) is a URL path, such as `/` or `/items/1` above, that is connected to a
Python function. When the client makes a request to the server at that path, the attached function
is executed.

For example, the line `@app.get("/items/{item_id}")` says: "when the browser (or any client) makes a
GET request to `/items/{item_id}`, run the function right below this line." The dictionary we return
in the function gets automatically converted into JSON (so it can be sent across the internet in a
standard format for ease of use).

> [!TIP]
>
> ### On Slugs
>
> You may notice that in our `/items` route we actually passed in a variable called `item_id` in
> curly braces. This is called a **slug**, and it is a type of path parameter that you can use to
> capture a value from the URL. For example, if the URL is `/items/52`, then `item_id` will be set
> to `52`. This approach is useful for all kinds of situations, such as accessing different blog
> posts or items sold in a store. As experimenters, we might use them for stimulus IDs or
> participant IDs. You can learn more about slugs in the
> [FastAPI docs](https://fastapi.tiangolo.com/tutorial/path-params/).

## Step 2: Run the server with `uvicorn`

Make sure your virtual environment is active (you should see `(.venv)` or `(bcog200)` or whatever
the name of our project environment is at the beginning of your terminal prompt). Then execute the
following command in your terminal:

```bash
uvicorn main:app --reload
```

Let's break this command down step by step:

- `uvicorn` => the command to run the server
- `main` => the file `main.py` (without the `.py`)
- `app` => the variable named `app` inside that file
- `--reload` => the flag to tell the server to restart automatically when you save any changes to your code. This is very helpful for development!

## Step 3: Visit your app in the browser

Once `uvicorn` has started, it will print something like:

```text
INFO:     Will watch for changes in these directories: ['/Users/yourusername/Desktop/bcog200_web']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [86932] using WatchFiles
INFO:     Started server process [86934]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

The most important line is the one that says `Uvicorn running on http://127.0.0.1:8000`. This means that the server is listening for requests at the URL `http://127.0.0.1:8000`. `http://` is the protocol (as distinct from other types of protocols like `ftp` or `ssh`), `127.0.0.1` is the local IP address of your computer (you can substitute it with `localhost` if you prefer), and `8000` is the port number.

Now open your browser and try these URLs:

- `http://127.0.0.1:8000/`
- `http://127.0.0.1:8000/items/1`

The first route will return a JSON response like:

```json
{
  "Hello": "World"
}
```

The second route will return a JSON response like:

```json
{
  "item_id": 1,
  "query": null
}
```

### JSON and query parameters

Recall that we learned a bit about **JSON** in [Chapter 4.3](../CH04/4.3.%20JSON%20Files.md). To jog
your memory, JSON is a standard format for representing data that can be easily read and written by
computers and humans alike. It actually looks a lot like a Python dictionary (or list of
dictionaries, depending on the data structure).

**Query parameters** are optional key-value pairs appended to the end of the URL using a question mark. For example, `http://127.0.0.1:8000/items/1?query=test` has the query parameter `query=test` which says that the value of `query` is the string `test`.

Now, if we add a query parameter to our URL, we should be able to see the query parameter in the response. Go to `http://127.0.0.1:8000/items/1?query=test` and you should see the response below:

```json
{
  "item_id": 1,
  "query": "test"
}
```

## Step 4: Try out the interactive docs

FastAPI generates interactive documentation for you automatically at the `/docs` and `/redoc` endpoints. (When I refer to endpoints like this, I mean you should substitute the full URL, such as `http://127.0.0.1:8000/docs` or `http://127.0.0.1:8000/redoc`.)

Open `/docs` and try clicking on `GET /items/{item_id}`, then click "Try it out", enter values for the `item_id` and `query` parameters, and click "Execute". This will send a GET request to the server at that endpoint, just as if you had gone to the URL `http://127.0.0.1:8000/items/1?query=test` in your browser.

This kind of interactive documentation can serve as a sort of "debugging dashboard", especially as we add more endpoints.

> [!NOTE]
>
> ### Stop the server
>
> While `uvicorn` is running, you may notice that you cannot interact with your terminal as
> expected. This is because your terminal is "occupied" by the server. To stop it, click anywhere on
> the terminal and press <kbd>Ctrl</kbd> + <kbd>C</kbd>. That's the universal shortcut to quit any
> process currently running in your terminal.

## Troubleshooting

If you managed to get through all the steps above, great! Feel free to move on to the next section.

If you ran into problems, this section will go through some common issues you might encounter when first running your server.

### "Address already in use"

This usually means something else is already running on port 8000 (perhaps you have another instance of `uvicorn` running in another terminal window?). You can always choose to run your server on a different port like so:

```bash
uvicorn main:app --reload --port 8001
```

### "Error loading ASGI app. Could not import module 'main'"

This usually means one of these is true:

- You're not in the folder that contains `main.py` (e.g. your `bcog200_web` folder) — this means your terminal is not in the correct directory
- Your file isn't named exactly `main.py` — simply rename it
- Your FastAPI variable isn't named `app` (e.g. it might be `app_web` or `app_main` or something else) — again, simply rename it

Next: [20.3. Drafting the Survey with HTML](20.3.%20Drafting%20the%20Survey%20with%20HTML.md)<br>
Previous: [20.1. Setup with uv](20.1.%20Setup%20with%20uv.md)
